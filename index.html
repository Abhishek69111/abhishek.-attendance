<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .status-present { background: linear-gradient(135deg, #10b981, #059669); }
        .status-absent { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-late { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-users-cog text-2xl"></i>
                    <h1 class="text-2xl font-bold">AttendanceHub Pro</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm opacity-90" id="currentDate"></span>
                    <button onclick="showAddEmployeeModal()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all duration-200 flex items-center space-x-2">
                        <i class="fas fa-user-plus"></i>
                        <span>Add Employee</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Employees</p>
                        <p class="text-3xl font-bold text-gray-800" id="totalEmployees">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Present Today</p>
                        <p class="text-3xl font-bold text-green-600" id="presentCount">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Absent Today</p>
                        <p class="text-3xl font-bold text-red-600" id="absentCount">0</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <i class="fas fa-times-circle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Late Arrivals</p>
                        <p class="text-3xl font-bold text-yellow-600" id="lateCount">0</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <i class="fas fa-clock text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-xl card-shadow mb-6">
            <div class="flex border-b border-gray-200">
                <button onclick="showTab('daily')" id="dailyTab" class="flex-1 px-6 py-4 text-center font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50">
                    <i class="fas fa-calendar-day mr-2"></i>Daily Attendance
                </button>
                <button onclick="showTab('monthly')" id="monthlyTab" class="flex-1 px-6 py-4 text-center font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-calendar-alt mr-2"></i>Monthly View
                </button>
                <button onclick="showTab('reports')" id="reportsTab" class="flex-1 px-6 py-4 text-center font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-chart-bar mr-2"></i>Monthly Reports
                </button>
                <button onclick="showTab('history')" id="historyTab" class="flex-1 px-6 py-4 text-center font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-history mr-2"></i>Historical Data
                </button>
            </div>
        </div>

        <!-- Daily Attendance Tab -->
        <div id="dailyContent" class="tab-content">
            <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-gray-800">Today's Attendance</h2>
                        <div class="flex items-center space-x-4">
                            <input type="text" id="searchInput" placeholder="Search employees..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button onclick="markAllPresent()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                                <i class="fas fa-check-double mr-2"></i>Mark All Present
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Login/Logout Times</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeeTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Employee rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Monthly View Tab -->
        <div id="monthlyContent" class="tab-content hidden">
            <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-gray-800">Monthly Attendance Calendar</h2>
                        <div class="flex items-center space-x-4">
                            <button onclick="previousMonth()" class="p-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="currentMonth" class="text-lg font-semibold text-gray-800"></span>
                            <button onclick="nextMonth()" class="p-2 text-gray-600 hover:text-gray-800">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div id="monthlyCalendar" class="overflow-x-auto">
                        <!-- Monthly calendar will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Reports Tab -->
        <div id="reportsContent" class="tab-content hidden">
            <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-gray-800">Monthly Attendance Report</h2>
                        <div class="flex items-center space-x-4">
                            <select id="reportMonth" onchange="generateReport()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <!-- Month options will be populated -->
                            </select>
                            <div class="flex space-x-2">
                                <button onclick="exportReport('csv')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                                    <i class="fas fa-file-csv mr-2"></i>Export CSV
                                </button>
                                <button onclick="exportReport('excel')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                                    <i class="fas fa-file-excel mr-2"></i>Export Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div id="monthlyReport">
                        <!-- Monthly report will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Historical Data Tab -->
        <div id="historyContent" class="tab-content hidden">
            <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-gray-800">Historical Attendance Data</h2>
                        <div class="flex items-center space-x-4">
                            <select id="historyEmployee" onchange="loadEmployeeHistory()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Select Employee</option>
                            </select>
                            <input type="date" id="historyFromDate" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <input type="date" id="historyToDate" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button onclick="filterHistoryData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                                <i class="fas fa-filter mr-2"></i>Filter
                            </button>
                            <div class="flex space-x-2">
                                <button onclick="exportHistoryData('csv')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                                    <i class="fas fa-file-csv mr-2"></i>CSV
                                </button>
                                <button onclick="exportHistoryData('excel')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                                    <i class="fas fa-file-excel mr-2"></i>Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div id="historyData">
                        <!-- Historical data will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Login Time Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-sign-in-alt text-blue-600 mr-2"></i>Employee Login
                </h3>
                <button onclick="hideLoginModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-gray-600 mb-2">Employee: <span id="loginEmployeeName" class="font-semibold"></span></p>
                <p class="text-gray-600 mb-4">Date: <span id="loginDate" class="font-semibold"></span></p>
            </div>
            <form onsubmit="recordLogin(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Login Time</label>
                        <input type="time" id="loginTime" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="loginStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="present">On Time</option>
                            <option value="late">Late Arrival</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                        <textarea id="loginNotes" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Add any notes..."></textarea>
                    </div>
                </div>
                <div class="flex space-x-4 mt-6">
                    <button type="button" onclick="hideLoginModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        <i class="fas fa-sign-in-alt mr-2"></i>Record Login
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logout Time Modal -->
    <div id="logoutModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-sign-out-alt text-purple-600 mr-2"></i>Employee Logout
                </h3>
                <button onclick="hideLogoutModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-gray-600 mb-2">Employee: <span id="logoutEmployeeName" class="font-semibold"></span></p>
                <p class="text-gray-600 mb-2">Date: <span id="logoutDate" class="font-semibold"></span></p>
                <p class="text-gray-600 mb-4">Login Time: <span id="logoutLoginTime" class="font-semibold text-green-600"></span></p>
            </div>
            <form onsubmit="recordLogout(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Logout Time</label>
                        <input type="time" id="logoutTime" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Total Hours</label>
                        <input type="text" id="totalHours" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                        <textarea id="logoutNotes" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Add any notes..."></textarea>
                    </div>
                </div>
                <div class="flex space-x-4 mt-6">
                    <button type="button" onclick="hideLogoutModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors duration-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>Record Logout
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Time Modal -->
    <div id="editTimeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-edit text-yellow-600 mr-2"></i>Edit Attendance
                </h3>
                <button onclick="hideEditTimeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-gray-600 mb-2">Employee: <span id="editEmployeeName" class="font-semibold"></span></p>
                <p class="text-gray-600 mb-4">Date: <span id="editDate" class="font-semibold"></span></p>
            </div>
            <form onsubmit="updateAttendanceTime(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Login Time</label>
                        <input type="time" id="editLoginTime" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Logout Time</label>
                        <input type="time" id="editLogoutTime" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="editStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                            <option value="present">Present</option>
                            <option value="late">Late</option>
                            <option value="absent">Absent</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea id="editNotes" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" placeholder="Add any notes..."></textarea>
                    </div>
                </div>
                <div class="flex space-x-4 mt-6">
                    <button type="button" onclick="hideEditTimeModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors duration-200">
                        <i class="fas fa-save mr-2"></i>Update
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Add New Employee</h3>
                <button onclick="hideAddEmployeeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form onsubmit="addEmployee(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" id="employeeName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Employee ID</label>
                        <input type="text" id="employeeId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                        <select id="employeeDepartment" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select Department</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                            <option value="Finance">Finance</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                        <input type="text" id="employeePosition" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date of Joining</label>
                        <input type="date" id="employeeDateOfJoining" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <div class="flex space-x-4 mt-6">
                    <button type="button" onclick="hideAddEmployeeModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        Add Employee
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let attendance = JSON.parse(localStorage.getItem('attendance')) || {};
        let currentViewDate = new Date();
        let activeTab = 'daily';
        let currentEditingEmployee = null;

        // Initialize the application
        function init() {
            updateCurrentDate();
            renderEmployeeTable();
            updateStats();
            setupSearch();
            populateReportMonths();
            updateMonthDisplay();
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50');
                tab.classList.add('text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTabElement = document.getElementById(tabName + 'Tab');
            activeTabElement.classList.remove('text-gray-500');
            activeTabElement.classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50');
            
            activeTab = tabName;
            
            // Load content based on tab
            if (tabName === 'monthly') {
                renderMonthlyCalendar();
            } else if (tabName === 'reports') {
                generateReport();
            } else if (tabName === 'history') {
                populateEmployeeDropdown();
                loadAllHistoryData();
            }
        }

        // Update current date display
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
        }

        // Show add employee modal
        function showAddEmployeeModal() {
            document.getElementById('addEmployeeModal').classList.remove('hidden');
            document.getElementById('addEmployeeModal').classList.add('flex');
        }

        // Hide add employee modal
        function hideAddEmployeeModal() {
            document.getElementById('addEmployeeModal').classList.add('hidden');
            document.getElementById('addEmployeeModal').classList.remove('flex');
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeDepartment').value = '';
            document.getElementById('employeePosition').value = '';
            document.getElementById('employeeDateOfJoining').value = '';
        }

        // Add new employee
        function addEmployee(event) {
            event.preventDefault();
            
            const name = document.getElementById('employeeName').value;
            const id = document.getElementById('employeeId').value;
            const department = document.getElementById('employeeDepartment').value;
            const position = document.getElementById('employeePosition').value;
            const dateOfJoining = document.getElementById('employeeDateOfJoining').value;

            // Check if employee ID already exists
            if (employees.find(emp => emp.id === id)) {
                alert('Employee ID already exists. Please use a different ID.');
                return;
            }

            const newEmployee = {
                id: id,
                name: name,
                department: department,
                position: position,
                dateOfJoining: dateOfJoining,
                dateAdded: new Date().toISOString()
            };

            employees.push(newEmployee);
            localStorage.setItem('employees', JSON.stringify(employees));
            
            hideAddEmployeeModal();
            renderEmployeeTable();
            updateStats();
        }

        // Get today's date key
        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }

        // Show login modal
        function showLoginModal(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            currentEditingEmployee = employeeId;
            document.getElementById('loginEmployeeName').textContent = employee.name;
            document.getElementById('loginDate').textContent = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Set current time as default
            const now = new Date();
            document.getElementById('loginTime').value = now.toTimeString().slice(0, 5);
            document.getElementById('loginStatus').value = 'present';
            document.getElementById('loginNotes').value = '';
            
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('flex');
        }

        // Hide login modal
        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('flex');
            currentEditingEmployee = null;
        }

        // Record login
        function recordLogin(event) {
            event.preventDefault();
            
            const loginTime = document.getElementById('loginTime').value;
            const status = document.getElementById('loginStatus').value;
            const notes = document.getElementById('loginNotes').value;
            
            const today = getTodayKey();
            if (!attendance[today]) {
                attendance[today] = {};
            }
            
            attendance[today][currentEditingEmployee] = {
                status: status,
                loginTime: loginTime,
                logoutTime: null,
                totalHours: null,
                notes: notes,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('attendance', JSON.stringify(attendance));
            hideLoginModal();
            renderEmployeeTable();
            updateStats();
        }

        // Show logout modal
        function showLogoutModal(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            const today = getTodayKey();
            const todayAttendance = attendance[today] && attendance[today][employeeId];
            
            if (!todayAttendance || !todayAttendance.loginTime) {
                alert('Employee must login first before logout!');
                return;
            }
            
            currentEditingEmployee = employeeId;
            document.getElementById('logoutEmployeeName').textContent = employee.name;
            document.getElementById('logoutDate').textContent = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('logoutLoginTime').textContent = todayAttendance.loginTime;
            
            // Set current time as default
            const now = new Date();
            document.getElementById('logoutTime').value = now.toTimeString().slice(0, 5);
            document.getElementById('logoutNotes').value = '';
            
            // Calculate total hours when logout time changes
            document.getElementById('logoutTime').addEventListener('change', calculateTotalHours);
            calculateTotalHours(); // Calculate initial value
            
            document.getElementById('logoutModal').classList.remove('hidden');
            document.getElementById('logoutModal').classList.add('flex');
        }

        // Hide logout modal
        function hideLogoutModal() {
            document.getElementById('logoutModal').classList.add('hidden');
            document.getElementById('logoutModal').classList.remove('flex');
            document.getElementById('logoutTime').removeEventListener('change', calculateTotalHours);
            currentEditingEmployee = null;
        }

        // Calculate total hours
        function calculateTotalHours() {
            const today = getTodayKey();
            const todayAttendance = attendance[today] && attendance[today][currentEditingEmployee];
            
            if (!todayAttendance || !todayAttendance.loginTime) return;
            
            const loginTime = todayAttendance.loginTime;
            const logoutTime = document.getElementById('logoutTime').value;
            
            if (loginTime && logoutTime) {
                const login = new Date(`2000-01-01 ${loginTime}`);
                const logout = new Date(`2000-01-01 ${logoutTime}`);
                
                let diffMs = logout - login;
                if (diffMs < 0) {
                    // Handle next day logout
                    diffMs += 24 * 60 * 60 * 1000;
                }
                
                const hours = Math.floor(diffMs / (1000 * 60 * 60));
                const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                document.getElementById('totalHours').value = `${hours}h ${minutes}m`;
            }
        }

        // Record logout
        function recordLogout(event) {
            event.preventDefault();
            
            const logoutTime = document.getElementById('logoutTime').value;
            const notes = document.getElementById('logoutNotes').value;
            const totalHours = document.getElementById('totalHours').value;
            
            const today = getTodayKey();
            if (attendance[today] && attendance[today][currentEditingEmployee]) {
                attendance[today][currentEditingEmployee].logoutTime = logoutTime;
                attendance[today][currentEditingEmployee].totalHours = totalHours;
                if (notes) {
                    attendance[today][currentEditingEmployee].notes = 
                        (attendance[today][currentEditingEmployee].notes || '') + 
                        (attendance[today][currentEditingEmployee].notes ? ' | Logout: ' : '') + notes;
                }
                attendance[today][currentEditingEmployee].lastUpdated = new Date().toISOString();
            }
            
            localStorage.setItem('attendance', JSON.stringify(attendance));
            hideLogoutModal();
            renderEmployeeTable();
            updateStats();
        }

        // Show edit time modal
        function showEditTimeModal(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            const today = getTodayKey();
            const todayAttendance = attendance[today] && attendance[today][employeeId];
            
            currentEditingEmployee = employeeId;
            document.getElementById('editEmployeeName').textContent = employee.name;
            document.getElementById('editDate').textContent = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Pre-fill existing data
            if (todayAttendance) {
                document.getElementById('editLoginTime').value = todayAttendance.loginTime || '';
                document.getElementById('editLogoutTime').value = todayAttendance.logoutTime || '';
                document.getElementById('editStatus').value = todayAttendance.status || 'present';
                document.getElementById('editNotes').value = todayAttendance.notes || '';
            } else {
                document.getElementById('editLoginTime').value = '';
                document.getElementById('editLogoutTime').value = '';
                document.getElementById('editStatus').value = 'present';
                document.getElementById('editNotes').value = '';
            }
            
            document.getElementById('editTimeModal').classList.remove('hidden');
            document.getElementById('editTimeModal').classList.add('flex');
        }

        // Hide edit time modal
        function hideEditTimeModal() {
            document.getElementById('editTimeModal').classList.add('hidden');
            document.getElementById('editTimeModal').classList.remove('flex');
            currentEditingEmployee = null;
        }

        // Update attendance time
        function updateAttendanceTime(event) {
            event.preventDefault();
            
            const loginTime = document.getElementById('editLoginTime').value;
            const logoutTime = document.getElementById('editLogoutTime').value;
            const status = document.getElementById('editStatus').value;
            const notes = document.getElementById('editNotes').value;
            
            const today = getTodayKey();
            if (!attendance[today]) {
                attendance[today] = {};
            }
            
            let totalHours = null;
            if (loginTime && logoutTime) {
                const login = new Date(`2000-01-01 ${loginTime}`);
                const logout = new Date(`2000-01-01 ${logoutTime}`);
                
                let diffMs = logout - login;
                if (diffMs < 0) {
                    diffMs += 24 * 60 * 60 * 1000;
                }
                
                const hours = Math.floor(diffMs / (1000 * 60 * 60));
                const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                totalHours = `${hours}h ${minutes}m`;
            }
            
            attendance[today][currentEditingEmployee] = {
                status: status,
                loginTime: loginTime || null,
                logoutTime: logoutTime || null,
                totalHours: totalHours,
                notes: notes,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('attendance', JSON.stringify(attendance));
            hideEditTimeModal();
            renderEmployeeTable();
            updateStats();
        }

        // Mark attendance (simplified for absent only)
        function markAttendance(employeeId, status) {
            const today = getTodayKey();
            if (!attendance[today]) {
                attendance[today] = {};
            }
            
            attendance[today][employeeId] = {
                status: status,
                loginTime: null,
                logoutTime: null,
                totalHours: null,
                notes: 'Marked as absent',
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('attendance', JSON.stringify(attendance));
            renderEmployeeTable();
            updateStats();
        }

        // Mark all employees as present
        function markAllPresent() {
            const today = getTodayKey();
            if (!attendance[today]) {
                attendance[today] = {};
            }
            
            employees.forEach(employee => {
                if (!attendance[today][employee.id]) {
                    attendance[today][employee.id] = {
                        status: 'present',
                        time: new Date().toLocaleTimeString('en-US', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        })
                    };
                }
            });
            
            localStorage.setItem('attendance', JSON.stringify(attendance));
            renderEmployeeTable();
            updateStats();
        }

        // Remove employee
        function removeEmployee(employeeId) {
            if (confirm('Are you sure you want to remove this employee?')) {
                employees = employees.filter(emp => emp.id !== employeeId);
                localStorage.setItem('employees', JSON.stringify(employees));
                renderEmployeeTable();
                updateStats();
            }
        }

        // Get employee attendance status for today
        function getAttendanceStatus(employeeId) {
            const today = getTodayKey();
            return attendance[today] && attendance[today][employeeId] 
                ? attendance[today][employeeId] 
                : null;
        }

        // Render employee table
        function renderEmployeeTable() {
            const tbody = document.getElementById('employeeTableBody');
            tbody.innerHTML = '';

            if (employees.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-users text-4xl mb-4 opacity-50"></i>
                            <p class="text-lg">No employees added yet</p>
                            <p class="text-sm">Click "Add Employee" to get started</p>
                        </td>
                    </tr>
                `;
                return;
            }

            employees.forEach(employee => {
                const attendanceStatus = getAttendanceStatus(employee.id);
                const statusBadge = getStatusBadge(attendanceStatus);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold">
                                    ${employee.name.charAt(0).toUpperCase()}
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${employee.name}</div>
                                <div class="text-sm text-gray-500">ID: ${employee.id}</div>
                                <div class="text-xs text-gray-400">Joined: ${new Date(employee.dateOfJoining).toLocaleDateString()}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${employee.department}</div>
                        <div class="text-sm text-gray-500">${employee.position}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${statusBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="space-y-1">
                            ${attendanceStatus && attendanceStatus.loginTime ? 
                                `<div><i class="fas fa-sign-in-alt text-green-600 mr-1"></i>In: ${attendanceStatus.loginTime}</div>` : ''}
                            ${attendanceStatus && attendanceStatus.logoutTime ? 
                                `<div><i class="fas fa-sign-out-alt text-red-600 mr-1"></i>Out: ${attendanceStatus.logoutTime}</div>` : ''}
                            ${attendanceStatus && attendanceStatus.totalHours ? 
                                `<div class="text-xs text-blue-600 font-medium"><i class="fas fa-clock mr-1"></i>${attendanceStatus.totalHours}</div>` : ''}
                            ${!attendanceStatus || (!attendanceStatus.loginTime && !attendanceStatus.logoutTime) ? '-' : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex flex-wrap gap-1">
                            <button onclick="showLoginModal('${employee.id}')" 
                                class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-2 py-1 rounded-full text-xs font-medium transition-colors duration-200">
                                <i class="fas fa-sign-in-alt mr-1"></i>Login
                            </button>
                            <button onclick="showLogoutModal('${employee.id}')" 
                                class="bg-purple-100 hover:bg-purple-200 text-purple-800 px-2 py-1 rounded-full text-xs font-medium transition-colors duration-200">
                                <i class="fas fa-sign-out-alt mr-1"></i>Logout
                            </button>
                            <button onclick="markAttendance('${employee.id}', 'absent')" 
                                class="bg-red-100 hover:bg-red-200 text-red-800 px-2 py-1 rounded-full text-xs font-medium transition-colors duration-200">
                                <i class="fas fa-times mr-1"></i>Absent
                            </button>
                            <button onclick="showEditTimeModal('${employee.id}')" 
                                class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium transition-colors duration-200">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button onclick="removeEmployee('${employee.id}')" 
                                class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded-full text-xs transition-colors duration-200">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Get status badge HTML
        function getStatusBadge(attendanceStatus) {
            if (!attendanceStatus) {
                return '<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Not Marked</span>';
            }

            const statusConfig = {
                present: { class: 'bg-green-100 text-green-800', icon: 'fa-check-circle', text: 'Present' },
                absent: { class: 'bg-red-100 text-red-800', icon: 'fa-times-circle', text: 'Absent' },
                late: { class: 'bg-yellow-100 text-yellow-800', icon: 'fa-clock', text: 'Late' }
            };

            const config = statusConfig[attendanceStatus.status];
            return `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${config.class}">
                <i class="fas ${config.icon} mr-1"></i>${config.text}
            </span>`;
        }

        // Update statistics
        function updateStats() {
            const today = getTodayKey();
            const todayAttendance = attendance[today] || {};
            
            let presentCount = 0;
            let absentCount = 0;
            let lateCount = 0;

            employees.forEach(employee => {
                const status = todayAttendance[employee.id];
                if (status) {
                    switch (status.status) {
                        case 'present': presentCount++; break;
                        case 'absent': absentCount++; break;
                        case 'late': lateCount++; break;
                    }
                }
            });

            document.getElementById('totalEmployees').textContent = employees.length;
            document.getElementById('presentCount').textContent = presentCount;
            document.getElementById('absentCount').textContent = absentCount;
            document.getElementById('lateCount').textContent = lateCount;
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#employeeTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // Monthly calendar functions
        function updateMonthDisplay() {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            document.getElementById('currentMonth').textContent = 
                `${monthNames[currentViewDate.getMonth()]} ${currentViewDate.getFullYear()}`;
        }

        function previousMonth() {
            currentViewDate.setMonth(currentViewDate.getMonth() - 1);
            updateMonthDisplay();
            if (activeTab === 'monthly') renderMonthlyCalendar();
        }

        function nextMonth() {
            currentViewDate.setMonth(currentViewDate.getMonth() + 1);
            updateMonthDisplay();
            if (activeTab === 'monthly') renderMonthlyCalendar();
        }

        function renderMonthlyCalendar() {
            const calendar = document.getElementById('monthlyCalendar');
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            
            // Get days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            
            let calendarHTML = `
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-200 px-2 py-3 text-xs font-medium text-gray-500 uppercase">Employee</th>
            `;
            
            // Add day headers
            for (let day = 1; day <= daysInMonth; day++) {
                calendarHTML += `<th class="border border-gray-200 px-1 py-3 text-xs font-medium text-gray-500 text-center min-w-[30px]">${day}</th>`;
            }
            calendarHTML += '</tr></thead><tbody>';
            
            // Add employee rows
            employees.forEach(employee => {
                calendarHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-2 py-2 font-medium text-sm">
                            <div class="flex items-center">
                                <div class="h-6 w-6 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white text-xs font-semibold mr-2">
                                    ${employee.name.charAt(0).toUpperCase()}
                                </div>
                                ${employee.name}
                            </div>
                        </td>
                `;
                
                // Add attendance cells for each day
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayAttendance = attendance[dateKey] && attendance[dateKey][employee.id];
                    
                    let cellClass = 'border border-gray-200 px-1 py-2 text-center text-xs';
                    let cellContent = '';
                    
                    if (dayAttendance) {
                        switch (dayAttendance.status) {
                            case 'present':
                                cellClass += ' bg-green-100';
                                cellContent = '<i class="fas fa-check text-green-600"></i>';
                                break;
                            case 'absent':
                                cellClass += ' bg-red-100';
                                cellContent = '<i class="fas fa-times text-red-600"></i>';
                                break;
                            case 'late':
                                cellClass += ' bg-yellow-100';
                                cellContent = '<i class="fas fa-clock text-yellow-600"></i>';
                                break;
                        }
                    } else {
                        cellContent = '-';
                    }
                    
                    calendarHTML += `<td class="${cellClass}">${cellContent}</td>`;
                }
                
                calendarHTML += '</tr>';
            });
            
            calendarHTML += '</tbody></table>';
            calendar.innerHTML = calendarHTML;
        }

        // Report functions
        function populateReportMonths() {
            const select = document.getElementById('reportMonth');
            const currentDate = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            // Add current month and previous 11 months
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const text = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
                
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                if (i === 0) option.selected = true;
                select.appendChild(option);
            }
        }

        function generateReport() {
            const reportContainer = document.getElementById('monthlyReport');
            const selectedMonth = document.getElementById('reportMonth').value;
            
            if (!selectedMonth) return;
            
            const [year, month] = selectedMonth.split('-');
            const daysInMonth = new Date(year, month, 0).getDate();
            
            let reportHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-500">Employee</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Total Days</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Present</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Absent</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Late</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Attendance %</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            employees.forEach(employee => {
                let presentDays = 0;
                let absentDays = 0;
                let lateDays = 0;
                let totalMarkedDays = 0;
                
                // Count attendance for each day of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = `${year}-${month.padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayAttendance = attendance[dateKey] && attendance[dateKey][employee.id];
                    
                    if (dayAttendance) {
                        totalMarkedDays++;
                        switch (dayAttendance.status) {
                            case 'present': presentDays++; break;
                            case 'absent': absentDays++; break;
                            case 'late': lateDays++; break;
                        }
                    }
                }
                
                const attendancePercentage = totalMarkedDays > 0 ? 
                    Math.round(((presentDays + lateDays) / totalMarkedDays) * 100) : 0;
                
                let percentageClass = 'text-gray-600';
                if (attendancePercentage >= 90) percentageClass = 'text-green-600 font-semibold';
                else if (attendancePercentage >= 75) percentageClass = 'text-yellow-600 font-semibold';
                else if (attendancePercentage < 75) percentageClass = 'text-red-600 font-semibold';
                
                reportHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3">
                            <div class="flex items-center">
                                <div class="h-8 w-8 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white text-sm font-semibold mr-3">
                                    ${employee.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">${employee.name}</div>
                                    <div class="text-sm text-gray-500">${employee.department}</div>
                                </div>
                            </div>
                        </td>
                        <td class="border border-gray-200 px-4 py-3 text-center font-medium">${daysInMonth}</td>
                        <td class="border border-gray-200 px-4 py-3 text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                ${presentDays}
                            </span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3 text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                ${absentDays}
                            </span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3 text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                ${lateDays}
                            </span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3 text-center">
                            <span class="${percentageClass}">${attendancePercentage}%</span>
                        </td>
                    </tr>
                `;
            });
            
            reportHTML += '</tbody></table></div>';
            reportContainer.innerHTML = reportHTML;
        }

        function exportReport(format = 'csv') {
            const selectedMonth = document.getElementById('reportMonth').value;
            if (!selectedMonth) {
                alert('Please select a month to export');
                return;
            }
            
            const [year, month] = selectedMonth.split('-');
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            const monthName = monthNames[parseInt(month) - 1];
            const daysInMonth = new Date(year, month, 0).getDate();
            
            if (format === 'excel') {
                try {
                    // Create Excel workbook
                    const wb = XLSX.utils.book_new();
                    
                    // ===== SHEET 1: MONTHLY SUMMARY =====
                    const summaryData = [
                        ['EMPLOYEE ATTENDANCE REPORT'],
                        [`Month: ${monthName} ${year}`],
                        [`Generated on: ${new Date().toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}`],
                        [`Total Employees: ${employees.length}`],
                        [''],
                        ['Employee Name', 'Employee ID', 'Department', 'Position', 'Date of Joining', 'Days Since Joining', 'Total Working Days', 'Present Days', 'Absent Days', 'Late Days', 'Attendance Rate', 'Performance Status']
                    ];
                    
                    employees.forEach(employee => {
                        let presentDays = 0;
                        let absentDays = 0;
                        let lateDays = 0;
                        let totalMarkedDays = 0;
                        
                        // Calculate attendance for the month
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateKey = `${year}-${month.padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const dayAttendance = attendance[dateKey] && attendance[dateKey][employee.id];
                            
                            if (dayAttendance) {
                                totalMarkedDays++;
                                switch (dayAttendance.status) {
                                    case 'present': presentDays++; break;
                                    case 'absent': absentDays++; break;
                                    case 'late': lateDays++; break;
                                }
                            }
                        }
                        
                        const attendancePercentage = totalMarkedDays > 0 ? 
                            Math.round(((presentDays + lateDays) / totalMarkedDays) * 100) : 0;
                        
                        // Calculate days since joining
                        const joiningDate = new Date(employee.dateOfJoining);
                        const lastDayOfMonth = new Date(year, month, 0);
                        const daysSinceJoining = Math.max(0, Math.floor((lastDayOfMonth - joiningDate) / (1000 * 60 * 60 * 24)));
                        
                        // Performance status
                        let performanceStatus = '';
                        if (attendancePercentage >= 95) performanceStatus = 'Excellent';
                        else if (attendancePercentage >= 90) performanceStatus = 'Good';
                        else if (attendancePercentage >= 80) performanceStatus = 'Average';
                        else if (attendancePercentage >= 70) performanceStatus = 'Below Average';
                        else performanceStatus = 'Poor';
                        
                        summaryData.push([
                            employee.name,
                            employee.id,
                            employee.department,
                            employee.position,
                            new Date(employee.dateOfJoining).toLocaleDateString('en-US'),
                            daysSinceJoining,
                            daysInMonth,
                            presentDays,
                            absentDays,
                            lateDays,
                            `${attendancePercentage}%`,
                            performanceStatus
                        ]);
                    });
                    
                    const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                    
                    // Set column widths for summary sheet
                    summaryWs['!cols'] = [
                        {wch: 25}, // Employee Name
                        {wch: 15}, // Employee ID
                        {wch: 18}, // Department
                        {wch: 20}, // Position
                        {wch: 15}, // Date of Joining
                        {wch: 18}, // Days Since Joining
                        {wch: 18}, // Total Working Days
                        {wch: 15}, // Present Days
                        {wch: 15}, // Absent Days
                        {wch: 12}, // Late Days
                        {wch: 18}, // Attendance Rate
                        {wch: 18}  // Performance Status
                    ];
                    
                    // Apply styles to summary sheet
                    const range = XLSX.utils.decode_range(summaryWs['!ref']);
                    
                    // Title styling
                    for (let row = 0; row <= 4; row++) {
                        for (let col = 0; col <= range.e.c; col++) {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            if (summaryWs[cellRef]) {
                                summaryWs[cellRef].s = {
                                    font: { bold: true, size: row === 0 ? 16 : 12 },
                                    alignment: { horizontal: 'center' }
                                };
                            }
                        }
                    }
                    
                    // Header row styling (row 5)
                    for (let col = 0; col <= range.e.c; col++) {
                        const cellRef = XLSX.utils.encode_cell({r: 5, c: col});
                        if (summaryWs[cellRef]) {
                            summaryWs[cellRef].s = {
                                font: { bold: true, color: { rgb: "FFFFFF" } },
                                fill: { fgColor: { rgb: "4472C4" } },
                                alignment: { horizontal: 'center', vertical: 'center' },
                                border: {
                                    top: { style: 'thin', color: { rgb: "000000" } },
                                    bottom: { style: 'thin', color: { rgb: "000000" } },
                                    left: { style: 'thin', color: { rgb: "000000" } },
                                    right: { style: 'thin', color: { rgb: "000000" } }
                                }
                            };
                        }
                    }
                    
                    // Data rows styling
                    for (let row = 6; row <= range.e.r; row++) {
                        for (let col = 0; col <= range.e.c; col++) {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            if (summaryWs[cellRef]) {
                                summaryWs[cellRef].s = {
                                    alignment: { horizontal: col <= 4 ? 'left' : 'center', vertical: 'center' },
                                    border: {
                                        top: { style: 'thin', color: { rgb: "D0D0D0" } },
                                        bottom: { style: 'thin', color: { rgb: "D0D0D0" } },
                                        left: { style: 'thin', color: { rgb: "D0D0D0" } },
                                        right: { style: 'thin', color: { rgb: "D0D0D0" } }
                                    }
                                };
                                
                                // Color code attendance rates
                                if (col === 10) { // Attendance Rate column
                                    const rate = parseInt(summaryWs[cellRef].v);
                                    if (rate >= 90) {
                                        summaryWs[cellRef].s.fill = { fgColor: { rgb: "C6EFCE" } };
                                        summaryWs[cellRef].s.font = { color: { rgb: "006100" } };
                                    } else if (rate >= 80) {
                                        summaryWs[cellRef].s.fill = { fgColor: { rgb: "FFEB9C" } };
                                        summaryWs[cellRef].s.font = { color: { rgb: "9C6500" } };
                                    } else if (rate < 80) {
                                        summaryWs[cellRef].s.fill = { fgColor: { rgb: "FFC7CE" } };
                                        summaryWs[cellRef].s.font = { color: { rgb: "9C0006" } };
                                    }
                                }
                            }
                        }
                    }
                    
                    XLSX.utils.book_append_sheet(wb, summaryWs, "Monthly Summary");
                    
                    // ===== SHEET 2: DAILY ATTENDANCE GRID =====
                    const dailyData = [
                        [`DAILY ATTENDANCE - ${monthName.toUpperCase()} ${year}`],
                        ['Legend: P = Present, A = Absent, L = Late, - = Not Marked'],
                        ['']
                    ];
                    
                    const dailyHeader = ['Employee Name', 'Department'];
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month - 1, day);
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                        dailyHeader.push(`${day}\n${dayName}`);
                    }
                    dailyHeader.push('Total P', 'Total A', 'Total L', 'Rate %');
                    dailyData.push(dailyHeader);
                    
                    employees.forEach(employee => {
                        const row = [employee.name, employee.department];
                        let monthlyPresent = 0, monthlyAbsent = 0, monthlyLate = 0;
                        
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateKey = `${year}-${month.padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const dayAttendance = attendance[dateKey] && attendance[dateKey][employee.id];
                            
                            if (dayAttendance) {
                                switch (dayAttendance.status) {
                                    case 'present': 
                                        row.push('P'); 
                                        monthlyPresent++; 
                                        break;
                                    case 'absent': 
                                        row.push('A'); 
                                        monthlyAbsent++; 
                                        break;
                                    case 'late': 
                                        row.push('L'); 
                                        monthlyLate++; 
                                        break;
                                    default: 
                                        row.push('-');
                                }
                            } else {
                                row.push('-');
                            }
                        }
                        
                        const totalMarked = monthlyPresent + monthlyAbsent + monthlyLate;
                        const attendanceRate = totalMarked > 0 ? Math.round(((monthlyPresent + monthlyLate) / totalMarked) * 100) : 0;
                        
                        row.push(monthlyPresent, monthlyAbsent, monthlyLate, `${attendanceRate}%`);
                        dailyData.push(row);
                    });
                    
                    const dailyWs = XLSX.utils.aoa_to_sheet(dailyData);
                    
                    // Set column widths for daily sheet
                    const dailyCols = [
                        {wch: 25}, // Employee Name
                        {wch: 18}  // Department
                    ];
                    for (let day = 1; day <= daysInMonth; day++) {
                        dailyCols.push({wch: 6}); // Day columns
                    }
                    dailyCols.push({wch: 8}, {wch: 8}, {wch: 8}, {wch: 10}); // Summary columns
                    dailyWs['!cols'] = dailyCols;
                    
                    // Style daily sheet
                    const dailyRange = XLSX.utils.decode_range(dailyWs['!ref']);
                    
                    // Title and legend styling
                    for (let row = 0; row <= 2; row++) {
                        for (let col = 0; col <= dailyRange.e.c; col++) {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            if (dailyWs[cellRef]) {
                                dailyWs[cellRef].s = {
                                    font: { bold: row === 0, size: row === 0 ? 14 : 10 },
                                    alignment: { horizontal: 'center' }
                                };
                            }
                        }
                    }
                    
                    // Header row styling (row 3)
                    for (let col = 0; col <= dailyRange.e.c; col++) {
                        const cellRef = XLSX.utils.encode_cell({r: 3, c: col});
                        if (dailyWs[cellRef]) {
                            dailyWs[cellRef].s = {
                                font: { bold: true, color: { rgb: "FFFFFF" }, size: 9 },
                                fill: { fgColor: { rgb: "70AD47" } },
                                alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                                border: {
                                    top: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    left: { style: 'thin' },
                                    right: { style: 'thin' }
                                }
                            };
                        }
                    }
                    
                    // Data rows styling with color coding
                    for (let row = 4; row <= dailyRange.e.r; row++) {
                        for (let col = 0; col <= dailyRange.e.c; col++) {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            if (dailyWs[cellRef]) {
                                const cellValue = dailyWs[cellRef].v;
                                let cellStyle = {
                                    alignment: { horizontal: col <= 1 ? 'left' : 'center', vertical: 'center' },
                                    border: {
                                        top: { style: 'thin', color: { rgb: "D0D0D0" } },
                                        bottom: { style: 'thin', color: { rgb: "D0D0D0" } },
                                        left: { style: 'thin', color: { rgb: "D0D0D0" } },
                                        right: { style: 'thin', color: { rgb: "D0D0D0" } }
                                    }
                                };
                                
                                // Color code attendance status
                                if (col >= 2 && col < 2 + daysInMonth) {
                                    if (cellValue === 'P') {
                                        cellStyle.fill = { fgColor: { rgb: "C6EFCE" } };
                                        cellStyle.font = { color: { rgb: "006100" }, bold: true };
                                    } else if (cellValue === 'A') {
                                        cellStyle.fill = { fgColor: { rgb: "FFC7CE" } };
                                        cellStyle.font = { color: { rgb: "9C0006" }, bold: true };
                                    } else if (cellValue === 'L') {
                                        cellStyle.fill = { fgColor: { rgb: "FFEB9C" } };
                                        cellStyle.font = { color: { rgb: "9C6500" }, bold: true };
                                    }
                                }
                                
                                // Color code attendance rate
                                if (col === dailyRange.e.c) { // Last column (Rate %)
                                    const rate = parseInt(cellValue);
                                    if (rate >= 90) {
                                        cellStyle.fill = { fgColor: { rgb: "C6EFCE" } };
                                        cellStyle.font = { color: { rgb: "006100" }, bold: true };
                                    } else if (rate >= 80) {
                                        cellStyle.fill = { fgColor: { rgb: "FFEB9C" } };
                                        cellStyle.font = { color: { rgb: "9C6500" }, bold: true };
                                    } else if (rate < 80) {
                                        cellStyle.fill = { fgColor: { rgb: "FFC7CE" } };
                                        cellStyle.font = { color: { rgb: "9C0006" }, bold: true };
                                    }
                                }
                                
                                dailyWs[cellRef].s = cellStyle;
                            }
                        }
                    }
                    
                    XLSX.utils.book_append_sheet(wb, dailyWs, "Daily Attendance Grid");
                    
                    // ===== SHEET 3: EMPLOYEE DETAILS =====
                    const employeeDetailsData = [
                        ['EMPLOYEE MASTER DATA'],
                        [`As of ${new Date().toLocaleDateString('en-US')}`],
                        [''],
                        ['Employee Name', 'Employee ID', 'Department', 'Position', 'Date of Joining', 'Employment Duration (Days)', 'Employment Duration (Months)', 'Status']
                    ];
                    
                    employees.forEach(employee => {
                        const joiningDate = new Date(employee.dateOfJoining);
                        const currentDate = new Date();
                        const daysSinceJoining = Math.floor((currentDate - joiningDate) / (1000 * 60 * 60 * 24));
                        const monthsSinceJoining = Math.floor(daysSinceJoining / 30.44); // Average days per month
                        
                        let employmentStatus = '';
                        if (daysSinceJoining < 90) employmentStatus = 'Probation';
                        else if (daysSinceJoining < 365) employmentStatus = 'Junior';
                        else if (daysSinceJoining < 1095) employmentStatus = 'Experienced';
                        else employmentStatus = 'Senior';
                        
                        employeeDetailsData.push([
                            employee.name,
                            employee.id,
                            employee.department,
                            employee.position,
                            joiningDate.toLocaleDateString('en-US'),
                            daysSinceJoining,
                            monthsSinceJoining,
                            employmentStatus
                        ]);
                    });
                    
                    const employeeWs = XLSX.utils.aoa_to_sheet(employeeDetailsData);
                    
                    // Set column widths for employee details sheet
                    employeeWs['!cols'] = [
                        {wch: 25}, // Employee Name
                        {wch: 15}, // Employee ID
                        {wch: 18}, // Department
                        {wch: 20}, // Position
                        {wch: 15}, // Date of Joining
                        {wch: 20}, // Employment Duration (Days)
                        {wch: 22}, // Employment Duration (Months)
                        {wch: 15}  // Status
                    ];
                    
                    // Style employee details sheet
                    const empRange = XLSX.utils.decode_range(employeeWs['!ref']);
                    
                    // Title styling
                    for (let row = 0; row <= 2; row++) {
                        for (let col = 0; col <= empRange.e.c; col++) {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            if (employeeWs[cellRef]) {
                                employeeWs[cellRef].s = {
                                    font: { bold: row === 0, size: row === 0 ? 14 : 10 },
                                    alignment: { horizontal: 'center' }
                                };
                            }
                        }
                    }
                    
                    // Header row styling (row 3)
                    for (let col = 0; col <= empRange.e.c; col++) {
                        const cellRef = XLSX.utils.encode_cell({r: 3, c: col});
                        if (employeeWs[cellRef]) {
                            employeeWs[cellRef].s = {
                                font: { bold: true, color: { rgb: "FFFFFF" } },
                                fill: { fgColor: { rgb: "E67E22" } },
                                alignment: { horizontal: 'center', vertical: 'center' },
                                border: {
                                    top: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    left: { style: 'thin' },
                                    right: { style: 'thin' }
                                }
                            };
                        }
                    }
                    
                    // Data rows styling
                    for (let row = 4; row <= empRange.e.r; row++) {
                        for (let col = 0; col <= empRange.e.c; col++) {
                            const cellRef = XLSX.utils.encode_cell({r: row, c: col});
                            if (employeeWs[cellRef]) {
                                employeeWs[cellRef].s = {
                                    alignment: { horizontal: col <= 3 ? 'left' : 'center', vertical: 'center' },
                                    border: {
                                        top: { style: 'thin', color: { rgb: "D0D0D0" } },
                                        bottom: { style: 'thin', color: { rgb: "D0D0D0" } },
                                        left: { style: 'thin', color: { rgb: "D0D0D0" } },
                                        right: { style: 'thin', color: { rgb: "D0D0D0" } }
                                    }
                                };
                            }
                        }
                    }
                    
                    XLSX.utils.book_append_sheet(wb, employeeWs, "Employee Details");
                    
                    // Save the Excel file
                    const fileName = `Attendance-Report-${monthName}-${year}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    // Show success message
                    alert(`Excel report "${fileName}" has been downloaded successfully!\n\nThe report contains:\n Monthly Summary with performance analysis\n Daily Attendance Grid with color coding\n Employee Master Data\n\nAll sheets are professionally formatted and ready for presentation.`);
                    
                } catch (error) {
                    console.error('Excel export error:', error);
                    alert('Error creating Excel file. Please try again or use CSV export.');
                }
                
            } else {
                // CSV export (existing functionality)
                let csvContent = `Employee Attendance Report - ${monthName} ${year}\n\n`;
                csvContent += "Employee Name,Employee ID,Department,Position,Date of Joining,Total Days,Present,Absent,Late,Attendance %,Days Since Joining\n";
                
                employees.forEach(employee => {
                    let presentDays = 0;
                    let absentDays = 0;
                    let lateDays = 0;
                    let totalMarkedDays = 0;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateKey = `${year}-${month.padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayAttendance = attendance[dateKey] && attendance[dateKey][employee.id];
                        
                        if (dayAttendance) {
                            totalMarkedDays++;
                            switch (dayAttendance.status) {
                                case 'present': presentDays++; break;
                                case 'absent': absentDays++; break;
                                case 'late': lateDays++; break;
                            }
                        }
                    }
                    
                    const attendancePercentage = totalMarkedDays > 0 ? 
                        Math.round(((presentDays + lateDays) / totalMarkedDays) * 100) : 0;
                    
                    const joiningDate = new Date(employee.dateOfJoining);
                    const lastDayOfMonth = new Date(year, month, 0);
                    const daysSinceJoining = Math.floor((lastDayOfMonth - joiningDate) / (1000 * 60 * 60 * 24));
                    
                    csvContent += `"${employee.name}","${employee.id}","${employee.department}","${employee.position}","${new Date(employee.dateOfJoining).toLocaleDateString()}",${daysInMonth},${presentDays},${absentDays},${lateDays},${attendancePercentage}%,${daysSinceJoining}\n`;
                });
                
                // Create and download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance-report-${monthName}-${year}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
        }

        // Historical Data Functions
        function populateEmployeeDropdown() {
            const select = document.getElementById('historyEmployee');
            select.innerHTML = '<option value="">All Employees</option>';
            
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.id})`;
                select.appendChild(option);
            });
        }

        function loadAllHistoryData() {
            const historyContainer = document.getElementById('historyData');
            
            // Get all attendance dates
            const allDates = Object.keys(attendance).sort().reverse();
            
            if (allDates.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-calendar-times text-4xl mb-4 opacity-50"></i>
                        <p class="text-lg">No attendance data found</p>
                        <p class="text-sm">Start marking attendance to see historical data</p>
                    </div>
                `;
                return;
            }

            let historyHTML = `
                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-2">Data Storage Information</h3>
                    <p class="text-sm text-blue-700">All attendance data is permanently stored in your browser's local storage. You can access historical data anytime, even after closing and reopening the application.</p>
                    <p class="text-sm text-blue-700 mt-1"><strong>Total Records:</strong> ${allDates.length} days of attendance data stored</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-500">Date</th>
                                <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-500">Employee</th>
                                <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-500">Department</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Status</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Time</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Days Since Joining</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            allDates.forEach(date => {
                const dayAttendance = attendance[date];
                Object.keys(dayAttendance).forEach(employeeId => {
                    const employee = employees.find(emp => emp.id === employeeId);
                    if (!employee) return;

                    const record = dayAttendance[employeeId];
                    const daysSinceJoining = Math.floor((new Date(date) - new Date(employee.dateOfJoining)) / (1000 * 60 * 60 * 24));
                    
                    let statusBadge = '';
                    switch (record.status) {
                        case 'present':
                            statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full"><i class="fas fa-check mr-1"></i>Present</span>';
                            break;
                        case 'absent':
                            statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full"><i class="fas fa-times mr-1"></i>Absent</span>';
                            break;
                        case 'late':
                            statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full"><i class="fas fa-clock mr-1"></i>Late</span>';
                            break;
                    }

                    historyHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-4 py-3 text-sm font-medium">${new Date(date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</td>
                            <td class="border border-gray-200 px-4 py-3">
                                <div class="flex items-center">
                                    <div class="h-6 w-6 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white text-xs font-semibold mr-2">
                                        ${employee.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">${employee.name}</div>
                                        <div class="text-xs text-gray-500">ID: ${employee.id}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="border border-gray-200 px-4 py-3 text-sm text-gray-900">${employee.department}</td>
                            <td class="border border-gray-200 px-4 py-3 text-center">${statusBadge}</td>
                            <td class="border border-gray-200 px-4 py-3 text-center text-sm text-gray-600">${record.time}</td>
                            <td class="border border-gray-200 px-4 py-3 text-center text-sm text-gray-600">${daysSinceJoining} days</td>
                        </tr>
                    `;
                });
            });

            historyHTML += '</tbody></table></div>';
            historyContainer.innerHTML = historyHTML;
        }

        function loadEmployeeHistory() {
            const selectedEmployeeId = document.getElementById('historyEmployee').value;
            
            if (!selectedEmployeeId) {
                loadAllHistoryData();
                return;
            }

            const employee = employees.find(emp => emp.id === selectedEmployeeId);
            if (!employee) return;

            const historyContainer = document.getElementById('historyData');
            const allDates = Object.keys(attendance).sort().reverse();
            
            let employeeRecords = [];
            allDates.forEach(date => {
                if (attendance[date] && attendance[date][selectedEmployeeId]) {
                    employeeRecords.push({
                        date: date,
                        record: attendance[date][selectedEmployeeId]
                    });
                }
            });

            if (employeeRecords.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-user-clock text-4xl mb-4 opacity-50"></i>
                        <p class="text-lg">No attendance records found for ${employee.name}</p>
                        <p class="text-sm">This employee's attendance data will appear here once marked</p>
                    </div>
                `;
                return;
            }

            // Calculate statistics
            let presentCount = 0, absentCount = 0, lateCount = 0;
            employeeRecords.forEach(record => {
                switch (record.record.status) {
                    case 'present': presentCount++; break;
                    case 'absent': absentCount++; break;
                    case 'late': lateCount++; break;
                }
            });

            const totalRecords = employeeRecords.length;
            const attendanceRate = Math.round(((presentCount + lateCount) / totalRecords) * 100);

            let historyHTML = `
                <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800">Employee Details</h4>
                        <p class="text-sm text-blue-700">${employee.name}</p>
                        <p class="text-xs text-blue-600">${employee.department} - ${employee.position}</p>
                        <p class="text-xs text-blue-600">Joined: ${new Date(employee.dateOfJoining).toLocaleDateString()}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-green-600">${presentCount}</p>
                        <p class="text-sm text-green-700">Present Days</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-red-600">${absentCount}</p>
                        <p class="text-sm text-red-700">Absent Days</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-yellow-600">${lateCount}</p>
                        <p class="text-sm text-yellow-700">Late Days</p>
                    </div>
                </div>
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-700"><strong>Total Records:</strong> ${totalRecords} days | <strong>Attendance Rate:</strong> <span class="font-semibold ${attendanceRate >= 90 ? 'text-green-600' : attendanceRate >= 75 ? 'text-yellow-600' : 'text-red-600'}">${attendanceRate}%</span></p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-500">Date</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Day</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Status</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Time</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Days Since Joining</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            employeeRecords.forEach(item => {
                const date = new Date(item.date);
                const daysSinceJoining = Math.floor((date - new Date(employee.dateOfJoining)) / (1000 * 60 * 60 * 24));
                
                let statusBadge = '';
                switch (item.record.status) {
                    case 'present':
                        statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full"><i class="fas fa-check mr-1"></i>Present</span>';
                        break;
                    case 'absent':
                        statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full"><i class="fas fa-times mr-1"></i>Absent</span>';
                        break;
                    case 'late':
                        statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full"><i class="fas fa-clock mr-1"></i>Late</span>';
                        break;
                }

                historyHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3 text-sm font-medium">${date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
                        <td class="border border-gray-200 px-4 py-3 text-center text-sm text-gray-600">${date.toLocaleDateString('en-US', { weekday: 'long' })}</td>
                        <td class="border border-gray-200 px-4 py-3 text-center">${statusBadge}</td>
                        <td class="border border-gray-200 px-4 py-3 text-center text-sm text-gray-600">${item.record.time}</td>
                        <td class="border border-gray-200 px-4 py-3 text-center text-sm text-gray-600">${daysSinceJoining} days</td>
                    </tr>
                `;
            });

            historyHTML += '</tbody></table></div>';
            historyContainer.innerHTML = historyHTML;
        }

        function filterHistoryData() {
            const selectedEmployeeId = document.getElementById('historyEmployee').value;
            const fromDate = document.getElementById('historyFromDate').value;
            const toDate = document.getElementById('historyToDate').value;

            if (!fromDate || !toDate) {
                alert('Please select both from and to dates');
                return;
            }

            const historyContainer = document.getElementById('historyData');
            let filteredRecords = [];

            // Get all dates in range
            const startDate = new Date(fromDate);
            const endDate = new Date(toDate);
            
            Object.keys(attendance).forEach(date => {
                const recordDate = new Date(date);
                if (recordDate >= startDate && recordDate <= endDate) {
                    if (selectedEmployeeId) {
                        // Filter for specific employee
                        if (attendance[date][selectedEmployeeId]) {
                            const employee = employees.find(emp => emp.id === selectedEmployeeId);
                            filteredRecords.push({
                                date: date,
                                employee: employee,
                                record: attendance[date][selectedEmployeeId]
                            });
                        }
                    } else {
                        // All employees
                        Object.keys(attendance[date]).forEach(empId => {
                            const employee = employees.find(emp => emp.id === empId);
                            if (employee) {
                                filteredRecords.push({
                                    date: date,
                                    employee: employee,
                                    record: attendance[date][empId]
                                });
                            }
                        });
                    }
                }
            });

            // Sort by date (newest first)
            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredRecords.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                        <p class="text-lg">No records found for the selected criteria</p>
                        <p class="text-sm">Try adjusting your date range or employee selection</p>
                    </div>
                `;
                return;
            }

            let historyHTML = `
                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-2">Filtered Results</h3>
                    <p class="text-sm text-blue-700">Showing ${filteredRecords.length} records from ${new Date(fromDate).toLocaleDateString()} to ${new Date(toDate).toLocaleDateString()}</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-500">Date</th>
                                <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-500">Employee</th>
                                <th class="border border-gray-200 px-4 py-3 text-left text-sm font-medium text-gray-500">Department</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Status</th>
                                <th class="border border-gray-200 px-4 py-3 text-center text-sm font-medium text-gray-500">Time</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            filteredRecords.forEach(item => {
                let statusBadge = '';
                switch (item.record.status) {
                    case 'present':
                        statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full"><i class="fas fa-check mr-1"></i>Present</span>';
                        break;
                    case 'absent':
                        statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full"><i class="fas fa-times mr-1"></i>Absent</span>';
                        break;
                    case 'late':
                        statusBadge = '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full"><i class="fas fa-clock mr-1"></i>Late</span>';
                        break;
                }

                historyHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3 text-sm font-medium">${new Date(item.date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</td>
                        <td class="border border-gray-200 px-4 py-3">
                            <div class="flex items-center">
                                <div class="h-6 w-6 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white text-xs font-semibold mr-2">
                                    ${item.employee.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${item.employee.name}</div>
                                    <div class="text-xs text-gray-500">ID: ${item.employee.id}</div>
                                </div>
                            </div>
                        </td>
                        <td class="border border-gray-200 px-4 py-3 text-sm text-gray-900">${item.employee.department}</td>
                        <td class="border border-gray-200 px-4 py-3 text-center">${statusBadge}</td>
                        <td class="border border-gray-200 px-4 py-3 text-center text-sm text-gray-600">${item.record.time}</td>
                    </tr>
                `;
            });

            historyHTML += '</tbody></table></div>';
            historyContainer.innerHTML = historyHTML;
        }

        function exportHistoryData(format = 'csv') {
            const selectedEmployeeId = document.getElementById('historyEmployee').value;
            const fromDate = document.getElementById('historyFromDate').value;
            const toDate = document.getElementById('historyToDate').value;

            // Get filtered data
            let exportRecords = [];
            Object.keys(attendance).forEach(date => {
                if (fromDate && toDate) {
                    const recordDate = new Date(date);
                    if (recordDate < new Date(fromDate) || recordDate > new Date(toDate)) {
                        return;
                    }
                }

                Object.keys(attendance[date]).forEach(empId => {
                    if (selectedEmployeeId && empId !== selectedEmployeeId) {
                        return;
                    }

                    const employee = employees.find(emp => emp.id === empId);
                    if (employee) {
                        exportRecords.push({
                            date: date,
                            employee: employee,
                            record: attendance[date][empId]
                        });
                    }
                });
            });

            // Sort by date
            exportRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            let filename = 'attendance-history';
            if (selectedEmployeeId) {
                const employee = employees.find(emp => emp.id === selectedEmployeeId);
                filename += `-${employee.name.replace(/\s+/g, '-')}`;
            }
            if (fromDate && toDate) {
                filename += `-${fromDate}-to-${toDate}`;
            }

            if (format === 'excel') {
                // Create Excel file
                const wb = XLSX.utils.book_new();
                
                // Summary information
                const summaryData = [
                    ['Historical Attendance Data Export'],
                    [''],
                    [`Export Date: ${new Date().toLocaleDateString()}`],
                    [`Total Records: ${exportRecords.length}`]
                ];
                
                if (fromDate && toDate) {
                    summaryData.push([`Date Range: ${new Date(fromDate).toLocaleDateString()} to ${new Date(toDate).toLocaleDateString()}`]);
                }
                
                if (selectedEmployeeId) {
                    const employee = employees.find(emp => emp.id === selectedEmployeeId);
                    summaryData.push([`Employee: ${employee.name} (${employee.id})`]);
                }
                
                summaryData.push([''], ['Date', 'Employee Name', 'Employee ID', 'Department', 'Position', 'Status', 'Time', 'Date of Joining', 'Days Since Joining']);
                
                // Add data rows
                exportRecords.forEach(item => {
                    const daysSinceJoining = Math.floor((new Date(item.date) - new Date(item.employee.dateOfJoining)) / (1000 * 60 * 60 * 24));
                    summaryData.push([
                        new Date(item.date).toLocaleDateString(),
                        item.employee.name,
                        item.employee.id,
                        item.employee.department,
                        item.employee.position,
                        item.record.status.toUpperCase(),
                        item.record.time,
                        new Date(item.employee.dateOfJoining).toLocaleDateString(),
                        daysSinceJoining
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(summaryData);
                
                // Set column widths
                ws['!cols'] = [
                    {wch: 12}, // Date
                    {wch: 20}, // Employee Name
                    {wch: 12}, // Employee ID
                    {wch: 15}, // Department
                    {wch: 15}, // Position
                    {wch: 10}, // Status
                    {wch: 10}, // Time
                    {wch: 15}, // Date of Joining
                    {wch: 15}  // Days Since Joining
                ];
                
                // Style the header row
                const headerRowIndex = summaryData.findIndex(row => row[0] === 'Date') + 1; // +1 for 1-based indexing
                const headerStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4F46E5" } },
                    alignment: { horizontal: "center" }
                };
                
                for (let col = 0; col < 9; col++) {
                    const cellRef = XLSX.utils.encode_cell({ r: headerRowIndex - 1, c: col }); // -1 for 0-based indexing
                    if (!ws[cellRef]) ws[cellRef] = {};
                    ws[cellRef].s = headerStyle;
                }
                
                XLSX.utils.book_append_sheet(wb, ws, "Historical Data");
                
                // If specific employee selected, add detailed analysis sheet
                if (selectedEmployeeId) {
                    const employee = employees.find(emp => emp.id === selectedEmployeeId);
                    const employeeRecords = exportRecords.filter(record => record.employee.id === selectedEmployeeId);
                    
                    let presentCount = 0, absentCount = 0, lateCount = 0;
                    employeeRecords.forEach(record => {
                        switch (record.record.status) {
                            case 'present': presentCount++; break;
                            case 'absent': absentCount++; break;
                            case 'late': lateCount++; break;
                        }
                    });
                    
                    const attendanceRate = employeeRecords.length > 0 ? Math.round(((presentCount + lateCount) / employeeRecords.length) * 100) : 0;
                    
                    const analysisData = [
                        [`Employee Analysis: ${employee.name}`],
                        [''],
                        ['Employee Details'],
                        ['Name:', employee.name],
                        ['ID:', employee.id],
                        ['Department:', employee.department],
                        ['Position:', employee.position],
                        ['Date of Joining:', new Date(employee.dateOfJoining).toLocaleDateString()],
                        [''],
                        ['Attendance Summary'],
                        ['Total Records:', employeeRecords.length],
                        ['Present Days:', presentCount],
                        ['Absent Days:', absentCount],
                        ['Late Days:', lateCount],
                        ['Attendance Rate:', `${attendanceRate}%`],
                        [''],
                        ['Monthly Breakdown'],
                        ['Month', 'Present', 'Absent', 'Late', 'Total', 'Rate']
                    ];
                    
                    // Group by month
                    const monthlyData = {};
                    employeeRecords.forEach(record => {
                        const date = new Date(record.date);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                        
                        if (!monthlyData[monthKey]) {
                            monthlyData[monthKey] = { name: monthName, present: 0, absent: 0, late: 0 };
                        }
                        
                        monthlyData[monthKey][record.record.status]++;
                    });
                    
                    Object.values(monthlyData).forEach(month => {
                        const total = month.present + month.absent + month.late;
                        const rate = total > 0 ? Math.round(((month.present + month.late) / total) * 100) : 0;
                        analysisData.push([month.name, month.present, month.absent, month.late, total, `${rate}%`]);
                    });
                    
                    const analysisWs = XLSX.utils.aoa_to_sheet(analysisData);
                    analysisWs['!cols'] = [
                        {wch: 20}, // Month/Label
                        {wch: 10}, // Present
                        {wch: 10}, // Absent
                        {wch: 10}, // Late
                        {wch: 10}, // Total
                        {wch: 10}  // Rate
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, analysisWs, "Employee Analysis");
                }
                
                // Save the file
                XLSX.writeFile(wb, `${filename}.xlsx`);
                
            } else {
                // CSV export
                let csvContent = 'Historical Attendance Data Export\n\n';
                
                if (fromDate && toDate) {
                    csvContent += `Date Range: ${new Date(fromDate).toLocaleDateString()} to ${new Date(toDate).toLocaleDateString()}\n`;
                }
                
                if (selectedEmployeeId) {
                    const employee = employees.find(emp => emp.id === selectedEmployeeId);
                    csvContent += `Employee: ${employee.name} (${employee.id})\n`;
                }
                
                csvContent += `Export Date: ${new Date().toLocaleDateString()}\n\n`;
                csvContent += 'Date,Employee Name,Employee ID,Department,Position,Status,Time,Date of Joining,Days Since Joining\n';

                exportRecords.forEach(item => {
                    const daysSinceJoining = Math.floor((new Date(item.date) - new Date(item.employee.dateOfJoining)) / (1000 * 60 * 60 * 24));
                    csvContent += `"${new Date(item.date).toLocaleDateString()}","${item.employee.name}","${item.employee.id}","${item.employee.department}","${item.employee.position}","${item.record.status}","${item.record.time}","${new Date(item.employee.dateOfJoining).toLocaleDateString()}",${daysSinceJoining}\n`;
                });

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967b3079d57b0942',t:'MTc1Mzk0NDkxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
